https://wiki.openstack.org/wiki/NeutronDevstack

Nota: Para fazer Vagrant up tem de ter a pasta "data"

# Para obter o os serviços para o neutron temos de fazer enable:
disable_service n-net
enable_service q-svc
enable_service q-agt
enable_service q-dhcp
enable_service q-l3
enable_service q-meta
# Optional, to enable tempest configuration as part of devstack
enable_service tempest

#------------------------------------------------------------------------------#
Routing entre o MAC e a VM (DevStack)
#------------------------------------------------------------------------------#
Com estes serviços, o enable feito temos o OpenStack com neutron.

Agora é preciso configurar a network privada, com um host-only adapater
conseguimos ter uma interface do mac na VM e um no mac que vai permitir fazer
forward dos pacotes entre o mac e a VM. Na Vagrantfile temos uma private_network
config.vm.network "private_network", ip: "172.18.161.6"

+--------------+                       +--------------+
|              |                       |              |
|     OSX      |   Host-Only Adapter   | DevStack VM  |  Private network to
|              +---------------------->+    eth1      |  management
| 172.18.161.1 |                       | 172.18.161.6 |
+--------------+                       +--------------+
                  NAT adapter to       |    eth0      |
+--------------+  provide connectivity |  10.0.2.15   |  Public network
|   8.8.8.8    |  to the VM            +------^-------+
|    WORLD     +------------------------------+
+--------------+

Ponto importante, o mac tem de ter o forwarding dos pacotes ativos para fazer o
forward dos pacotes que são enviados através do mac para a VM.
Ou seja, caso estejamos no mac a fazer ping a 172.24.4.2 que pode ser um IP de
um router do DevStack. ping 172.24.4.2 o mac tem de ter uma rota para a rede
172.24.4.0/24 através o host-only adapter, ou seja, next-hop: 172.18.161.6 e
este já tem a regra que todos os pacotes que cheguem para ir para 172.18.161.6
tem de ir para o vboxnet que é o adapter quando fazemos ifconfig.

Portanto, forwarding:
# forwarding packets mac
sudo sysctl -w net.inet.ip.forwarding=1

Agora a rota:
# para os routers do DevStack
sudo route add -net 172.24.4.0/24 172.18.161.6

# para as redes internas, caso seja necessário
sudo route add -net 10.0.0.0/24 172.18.161.6

# para remover as rotas da routing table
sudo route -n delete 10.0.0.0/24 172.18.161.1

agora para verificar se está tudo bem, podemos tentar ver se a rota para o
router do projeto "demo" vai pelo gateway que pretendemos, ou seja, o:
172.18.161.6

$ route get 172.24.4.2

output:

route to: 172.24.4.2
destination: 172.24.4.0
      mask: 255.255.255.0
   gateway: 172.18.161.6
 interface: vboxnet6
     flags: <UP,GATEWAY,DONE,STATIC,PRCLONING>
recvpipe  sendpipe  ssthresh  rtt,msec    rttvar  hopcount      mtu     expire
      0         0         0         0         0         0      1500         0

correto, está tudo bem configurado!


#------------------------------------------------------------------------------#
Configurar o Neutron
#------------------------------------------------------------------------------#

Primeiro, abrir a Vagrantfile

Vamos usar um ficheiro bootstrap.sh para fazer o update ao ubuntu, instalar o
git, fazer clone do repositório do DevStack e copiar o local.conf para o
diretório do OpenStack.
config.vm.provision :shell, path: "bootstrap.sh"

A memória atribuída à VM (máxima) é de 8GB no meu caso
vb.memory = "8192"

Depois, vamos ao local.conf:
No repositório do DevStack está em samples/local.conf um exemplo de um ficheiro
de configuração necessário para o DevStack funcionar.

Usando este tutorial: http://docs.openstack.org/developer/devstack/guides/neutron.html

apenas interessa as seguintes configurações, que estão presentes no local.conf:

ADMIN_PASSWORD=admin
MYSQL_PASSWORD=admin
RABBIT_PASSWORD=admin
SERVICE_PASSWORD=admin
SERVICE_TOKEN=admin

## Neutron options
Q_USE_SECGROUP=True
Q_L3_ENABLED=True
OVS_PHYSICAL_BRIDGE=br-ex
PUBLIC_BRIDGE=br-ex
OVS_BRIDGE_MAPPINGS=public:br-ex

disable_service n-net
enable_service q-svc
enable_service q-agt
enable_service q-dhcp
enable_service q-meta
enable_service q-l3

#------------------------------------------------------------------------------#
Testar a interface de admin e keystone
#------------------------------------------------------------------------------#

http://docs.openstack.org/admin-guide-cloud/index.html
Interface do Openstack, projeto de administração, Access & Security e depois
"Download OpenStack RC File", colocar na pasta do Vagrantfile que é partilhada
como Ubuntu e está tudo acessível apartir do Ubuntu.

Depois no ubuntu: source file.rc

http://docs.openstack.org/admin-guide-cloud/networking_use.html
http://docs.openstack.org/user-guide/index.html

keystone tenant-list | grep "demo"

por exemplo, o id do projeto é: 619c603290d34916a5f176ad74fe52a9

#------------------------------------------------------------------------------#
Comandos para usar no Ubuntu que tem o DevStack
#------------------------------------------------------------------------------#
$ sysctl -a | grep forward

para ver se forwarding está ativo

$ ip netns

para ver quais os routeres associados, por exemplo:

vagrant@vagrant-ubuntu-trusty-64:~$ ip netns
qrouter-e856c031-46db-4d1b-a535-fe9073af2230
qdhcp-af7602d7-989e-4173-9872-34564d8ddd3e

o nosso router do demo é:
qrouter-e856c031-46db-4d1b-a535-fe9073af2230

$ sudo ip netns exec qrouter-e856c031-46db-4d1b-a535-fe9073af2230 ping 10.0.0.3
$ sudo ip netns exec ROUTER_NAME COMMAND

$ ip r
para ver as rotas disponíveis

$ sudo ip route add 10.0.0.0/24 via 172.24.4.2 dev br-ex
para adicionar uma nova rota no ubuntu 
